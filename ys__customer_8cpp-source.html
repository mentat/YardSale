<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>YardSale: ys_customer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>ys_customer.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include "extra/xrc/xmlres.h"</span>
00002 <span class="preprocessor">#include "wx/app.h"</span>
00003 <span class="preprocessor">#include "wx/listctrl.h"</span>
00004 <span class="preprocessor">#include "wx/treectrl.h"</span>
00005 <span class="preprocessor">#include "wx/sizer.h"</span>
00006 <span class="preprocessor">#include "wx/log.h"</span>
00007 <span class="preprocessor">#include "wx/stattext.h"</span>
00008 
00009 <span class="preprocessor">#include "ys_customer.h"</span>
00010 <span class="preprocessor">#include "ys_exception.h"</span>
00011 <span class="preprocessor">#include "ys_database.h"</span>
00012 <span class="preprocessor">#include "ys_new_cust.h"</span>
00013 <span class="preprocessor">#include "yardsale.h"</span>
00014 
00015 <span class="preprocessor">#include "images/worker_16x16.xpm"</span>
00016 
00017 DECLARE_APP(<a class="code" href="class_yard_sale.html">YardSale</a>)
00018 
00019 <span class="keyword">class </span>custItemData: <span class="keyword">public</span> wxTreeItemData
00020 {
00021  <span class="keyword">public</span>:
00022     custItemData(<span class="keywordtype">long</span> id): 
00023         wxTreeItemData(), m_id(id) {}
00024     ~custItemData() {}
00025     
00026     <span class="keyword">const</span> <span class="keywordtype">long</span> GetID() { <span class="keywordflow">return</span> m_id; }
00027 
00028  <span class="keyword">private</span>:
00029     <span class="keywordtype">long</span> m_id;  
00030 };
00031 
00032 BEGIN_EVENT_TABLE(<a class="code" href="class_yard_customer.html">YardCustomer</a>, wxDialog)
00033     EVT_TREE_SEL_CHANGED(XRCID(<span class="stringliteral">"ID_CUST_TREE"</span>), YardCustomer::OnChange)
00034     EVT_BUTTON(XRCID(<span class="stringliteral">"ID_CUST_NEW"</span>), YardCustomer::OnNew)
00035     EVT_BUTTON(XRCID(<span class="stringliteral">"ID_CUST_EXIT"</span>), YardCustomer::OnExit)
00036    <span class="comment">// EVT_CLOSE(YardCustomer::OnClose)</span>
00037     EVT_TEXT(-1, YardCustomer::OnModify)
00038     EVT_BUTTON(XRCID(<span class="stringliteral">"ID_CUST_SAVE"</span>), YardCustomer::OnSave)
00039 END_EVENT_TABLE()
00040 
00041 YardCustomer::YardCustomer(wxWindow* parent, wxWindowID id, 
00042     <span class="keyword">const</span> wxString&amp; title, <span class="keyword">const</span> wxPoint&amp; pos,
00043     <span class="keyword">const</span> wxSize&amp; size, <span class="keywordtype">long</span> style, <span class="keyword">const</span> wxString&amp; name)
00044 :wxDialog(parent, id, title, pos, size, style, name), m_loading(true) {
00045     wxBusyCursor busy();
00046     wxXmlResource::Get()-&gt;Load(<span class="stringliteral">"res/customer.xrc"</span>);
00047     wxPanel * panel = wxXmlResource::Get()-&gt;LoadPanel(<span class="keyword">this</span>, <span class="stringliteral">"Customer"</span>);
00048     wxSizer * sizer = panel-&gt;GetSizer();
00049     sizer-&gt;SetSizeHints(<span class="keyword">this</span>);
00050     SetSize(wxSize(600,400));
00051     Centre();  
00052     
00053     
00054     m_pic = static_cast&lt;wxStaticBitmap *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_PICTURE"</span>)));
00055     m_sig = static_cast&lt;wxStaticBitmap *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_SIG"</span>)));
00056     m_tree = static_cast&lt;wxTreeCtrl *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_TREE"</span>)));
00057     m_first = static_cast&lt;wxTextCtrl *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_FIRST"</span>)));
00058     m_middle = static_cast&lt;wxTextCtrl *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_MIDDLE"</span>)));
00059     m_last = static_cast&lt;wxTextCtrl *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_LAST"</span>)));
00060     m_address = static_cast&lt;wxTextCtrl *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_ADDRESS"</span>)));
00061     m_ccNum = static_cast&lt;wxTextCtrl *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_CC"</span>)));
00062     m_ccName = static_cast&lt;wxTextCtrl *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_CC_NAME"</span>)));
00063     m_ccExp = static_cast&lt;wxTextCtrl *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_CC_EXP"</span>)));
00064     m_phone = static_cast&lt;wxTextCtrl *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_PHONE"</span>)));
00065     m_custSince = static_cast&lt;wxStaticText *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_SINCE"</span>)));
00066     m_save = static_cast&lt;wxButton *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_CUST_SAVE"</span>)));
00067     
00068     CreateImageList(m_tree);
00069     LoadTreeItems(m_tree);
00070     <span class="comment">//ID_CUST_PICTURE</span>
00071     m_loading = <span class="keyword">false</span>;
00072     
00073 }
00074 
00075 <span class="keywordtype">void</span> YardCustomer::LoadTreeItems(wxTreeCtrl * tree)
00076 {
00077     <span class="comment">//tree-&gt;SetWindowStyleFlag(wxTR_NO_LINES | wxTR_HIDE_ROOT | wxTR_FULL_ROW_HIGHLIGHT);</span>
00078     tree-&gt;AddRoot(wxT(<span class="stringliteral">"Root"</span>));
00079     tree-&gt;SetIndent(10);
00080     tree-&gt;SetSpacing(3);
00081     
00082     vector&lt;YardCustType&gt; customers;
00083     
00084     <span class="keywordflow">try</span> {
00085         customers = wxGetApp().DB().CustomerGetAll();
00086     }
00087     <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)
00088     {
00089         wxLogDebug(wxT(<span class="stringliteral">"Error (cust load): %s, %s"</span>),e.what(), e.GetSQL().c_str());
00090         <span class="keywordflow">return</span>;
00091     }
00092     wxLogDebug(wxT(<span class="stringliteral">"Got %d customers"</span>), customers.size());
00093     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; customers.size(); i++)
00094     {
00095         wxTreeItemId groupid = tree-&gt;AppendItem(tree-&gt;GetRootItem(),
00096             customers[i].GetFirstLast().c_str(), 0,0,
00097             <span class="keyword">new</span> custItemData(customers[i].GetAccountNumber()));
00098     }
00099     
00100 }
00101 
00102 <span class="keywordtype">void</span> YardCustomer::OnModify(wxCommandEvent&amp; event)
00103 {
00104  
00105     <span class="keywordflow">if</span> (!m_loading) 
00106     {        
00107         wxLogDebug(wxT(<span class="stringliteral">"OnModify"</span>));
00108         m_save-&gt;Show(<span class="keyword">true</span>);
00109     }
00110 }
00111 
00112 <span class="keywordtype">void</span> YardCustomer::OnSave(wxCommandEvent&amp; event)
00113 {
00114     wxLogDebug(wxT(<span class="stringliteral">"OnSave"</span>)); 
00115        
00116     m_cust.SetFirstName(m_first-&gt;GetValue().c_str());
00117     m_cust.SetMiddleName(m_middle-&gt;GetValue().c_str());
00118     m_cust.SetLastName(m_last-&gt;GetValue().c_str());
00119     m_cust.SetAddress(m_address-&gt;GetValue().c_str());
00120     m_cust.SetPhone(m_phone-&gt;GetValue().c_str());
00121     
00122     <span class="keywordflow">try</span> {
00123         <span class="comment">//wxGetApp().DB().CustomerUpdate(m_cust);</span>
00124     }
00125     <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)
00126     {
00127         wxMessageBox(wxT(<span class="stringliteral">"Could not save information."</span>), 
00128             wxT(<span class="stringliteral">"Save Error"</span>), wxOK, <span class="keyword">this</span>);
00129         <span class="keywordflow">return</span>;
00130     }
00131 
00132     m_save-&gt;Show(<span class="keyword">false</span>);
00133     
00134 }
00135 
00136 <span class="keywordtype">void</span> YardCustomer::OnClose(wxCloseEvent&amp; event)
00137 { 
00138     <span class="keywordflow">if</span> (event.CanVeto()) <span class="comment">// if this isnt a forced close, load login</span>
00139         GetParent()-&gt;Show();
00140     Destroy();
00141 }
00142 
00143 <span class="keywordtype">void</span> YardCustomer::OnExit(wxCommandEvent&amp; event)
00144 {
00145     wxLogDebug(wxT(<span class="stringliteral">"OnExit"</span>));
00146     EndModal(0);
00147 }
00148     
00149 YardCustomer::~YardCustomer()
00150 {
00151    
00152 
00153 }
00154 
00155 <span class="keywordtype">void</span> YardCustomer::CreateImageList(wxTreeCtrl * tree)
00156 {
00157     <span class="comment">// Make an image list containing small icons</span>
00158     wxImageList *images = <span class="keyword">new</span> wxImageList(16, 16, <span class="keyword">true</span>);
00159 
00160     wxIcon icons[1];
00161     
00162     icons[0] = wxIcon(worker_16x16_xpm);
00163     
00164     <span class="keywordflow">for</span> ( size_t i = 0; i &lt; WXSIZEOF(icons); i++ )
00165     { 
00166         images-&gt;Add(wxBitmap(icons[i]));
00167     }
00168 
00169     tree-&gt;AssignImageList(images);
00170 }
00171 
00172 <span class="keywordtype">void</span> YardCustomer::OnChange(wxTreeEvent&amp; event)
00173 {
00174     m_loading = <span class="keyword">true</span>;
00175     custItemData * data = static_cast&lt;custItemData *&gt;(m_tree-&gt;GetItemData(event.GetItem()));
00176 
00177     <span class="keywordflow">if</span> (!data)
00178         <span class="keywordflow">return</span>;
00179     
00180     <span class="keywordflow">try</span> {
00181         m_cust = wxGetApp().DB().CustomerGet(data-&gt;GetID());
00182     }
00183     <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)
00184     {
00185         wxLogDebug(wxT(<span class="stringliteral">"Error (customer not loaded): %s, %s"</span>),e.what(), e.GetSQL().c_str());
00186         <span class="keywordflow">return</span>;
00187     }
00188         
00189     <span class="keywordflow">if</span> (m_cust.GetPicLocal() != <span class="stringliteral">""</span>)
00190     {
00191         wxImage pic(m_cust.GetPicLocal().c_str());
00192         <span class="keywordflow">if</span> (pic.Ok())
00193             m_pic-&gt;SetBitmap(pic);
00194         <span class="keywordflow">else</span>
00195             wxLogDebug(wxT(<span class="stringliteral">"Bad image data (pic)."</span>));
00196     }
00197     <span class="keywordflow">else</span>
00198         m_pic-&gt;SetBitmap(wxImage(<span class="stringliteral">"res/personal.png"</span>));
00199     
00200     <span class="keywordflow">if</span> (m_cust.GetSigLocal() != <span class="stringliteral">""</span>)
00201     {
00202         wxImage sig(m_cust.GetSigLocal().c_str());
00203         <span class="keywordflow">if</span> (sig.Ok())
00204             m_sig-&gt;SetBitmap(sig);
00205         <span class="keywordflow">else</span>
00206             wxLogDebug(wxT(<span class="stringliteral">"Bad image data (sig)."</span>));
00207     }
00208     <span class="keywordflow">else</span>
00209         m_sig-&gt;SetBitmap(wxNullBitmap);
00210     
00211     m_first-&gt;SetValue(m_cust.GetFirstName().c_str());
00212     m_middle-&gt;SetValue(m_cust.GetMiddleName().c_str());
00213     m_last-&gt;SetValue(m_cust.GetLastName().c_str());
00214     m_address-&gt;SetValue(m_cust.GetAddress().c_str());
00215     m_ccNum-&gt;SetValue(m_cust.GetCreditCardNumber().c_str());
00216     m_ccName-&gt;SetValue(m_cust.GetCreditCardName().c_str());
00217     m_ccExp-&gt;SetValue(m_cust.GetCreditCardExpiration().c_str());
00218     m_phone-&gt;SetValue(m_cust.GetPhone().c_str());
00219     wxString pos;
00220     pos.Printf(wxT(<span class="stringliteral">"Customer Since: %s"</span>), m_cust.GetSince().c_str());
00221     m_custSince-&gt;SetLabel(pos);
00222     
00223     m_loading = <span class="keyword">false</span>;
00224 }
00225 
00226 <span class="keywordtype">void</span> YardCustomer::OnNew(wxCommandEvent&amp; event)
00227 {
00228     wxBitmap logo(<span class="stringliteral">"res/yast_sysadmin.png"</span>, wxBITMAP_TYPE_PNG);
00229     <a class="code" href="class_yard_new_customer.html">YardNewCustomer</a> * wizard = <span class="keyword">new</span> <a class="code" href="class_yard_new_customer.html">YardNewCustomer</a>(<span class="keyword">this</span>, -1, 
00230         wxT(<span class="stringliteral">"New Customer Wizard"</span>), logo);
00231     
00232     YardNewCustomer1 * page1 = <span class="keyword">new</span> YardNewCustomer1(wizard);
00233     YardNewCustomer2 * page2 = <span class="keyword">new</span> YardNewCustomer2(wizard);
00234     YardNewCustomer3 * page3 = <span class="keyword">new</span> YardNewCustomer3(wizard);
00235     YardNewCustomer4 * page4 = <span class="keyword">new</span> YardNewCustomer4(wizard);
00236     
00237     wxWizardPageSimple::Chain(page1, page2);
00238     wxWizardPageSimple::Chain(page2, page3);
00239     wxWizardPageSimple::Chain(page3, page4);
00240     
00241     wxSize min = page4-&gt;GetMin();
00242     wizard-&gt;SetPageSize(min);
00243 
00244     <span class="keywordflow">if</span> ( wizard-&gt;RunWizard(page1) )
00245     {
00246         wxLogDebug(wxT(<span class="stringliteral">"Wizard completed OK"</span>));
00247         
00248         YardCustType temp = wizard-&gt;<a class="code" href="class_yard_new_customer.html#a1">GetCustomer</a>();
00249         YardDate now(wxDateTime::Now());
00250         temp.SetSince(now);
00251         <span class="keywordflow">try</span> {
00252             wxGetApp().DB().CustomerAdd(temp);
00253         }
00254         <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)
00255         {
00256             wxLogDebug(wxT(<span class="stringliteral">"Error (customer not added): %s, %s"</span>),e.what(), e.GetSQL().c_str());
00257         }
00258     }
00259     wizard-&gt;Destroy();
00260     
00261 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun May 9 23:07:58 2004 for YardSale by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
