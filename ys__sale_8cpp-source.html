<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>YardSale: ys_sale.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>ys_sale.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;vector&gt;</span>
00002 
00003 <span class="preprocessor">#include "extra/xrc/xmlres.h"</span>
00004 <span class="preprocessor">#include "wx/app.h"</span>
00005 <span class="preprocessor">#include "wx/listctrl.h"</span>
00006 <span class="preprocessor">#include "wx/treectrl.h"</span>
00007 <span class="preprocessor">#include "wx/sizer.h"</span>
00008 <span class="preprocessor">#include "wx/log.h"</span>
00009 <span class="preprocessor">#include "wx/stattext.h"</span>
00010 <span class="preprocessor">#include "wx/notebook.h"</span>
00011 <span class="preprocessor">#include "wx/textctrl.h"</span>
00012 <span class="preprocessor">#include "wx/button.h"</span>
00013 
00014 <span class="preprocessor">#include "yardsale.h"</span>
00015 <span class="preprocessor">#include "ys_exception.h"</span>
00016 <span class="preprocessor">#include "ys_group.h"</span>
00017 <span class="preprocessor">#include "ys_inv_type.h"</span>
00018 <span class="preprocessor">#include "ys_sale.h"</span>
00019 <span class="preprocessor">#include "ys_database.h"</span>
00020 <span class="preprocessor">#include "ys_checkout.h"</span>
00021 
00022 <span class="preprocessor">#define SALE_BUTTON_HEIGHT      40</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#define START_BUTTON_ID         14333</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#define HIDDEN_BUTTON           14200</span>
00025 <span class="preprocessor"></span>
00026 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00027 
00028 
00029 BEGIN_EVENT_TABLE(<a class="code" href="class_yard_sale_screen.html">YardSaleScreen</a>, wxDialog)
00030     EVT_BUTTON(HIDDEN_BUTTON, YardSaleScreen::OnHidden)
00031     EVT_BUTTON(XRCID(<span class="stringliteral">"ID_SALES_EXIT"</span>), YardSaleScreen::OnExitButton)
00032     EVT_BUTTON(XRCID(<span class="stringliteral">"ID_SALES_REMOVE"</span>), YardSaleScreen::OnRemove)
00033     EVT_BUTTON(XRCID(<span class="stringliteral">"ID_SALES_CHECKOUT"</span>), YardSaleScreen::OnCheckout)
00034     EVT_BUTTON(-1, YardSaleScreen::OnItem)
00035     EVT_IDLE(YardSaleScreen::OnIdle)
00036     <span class="comment">//EVT_TREE_ITEM_ACTIVATED(XRCID("ID_SALE_TREE"), YardSaleScreen::OnChange)</span>
00037 END_EVENT_TABLE()
00038 
00039 DECLARE_APP(<a class="code" href="class_yard_sale.html">YardSale</a>)
00040 
00041 <span class="comment">// -1 is group</span>
00042 <span class="keyword">class </span>invItemData: <span class="keyword">public</span> wxTreeItemData
00043 {
00044  <span class="keyword">public</span>:
00045     invItemData(<span class="keywordtype">long</span> id): 
00046         wxTreeItemData(), m_id(id) {}
00047     ~invItemData() {}
00048     
00049     <span class="keyword">const</span> <span class="keywordtype">long</span> GetID() { <span class="keywordflow">return</span> m_id; }
00050 
00051  <span class="keyword">private</span>:
00052     <span class="keywordtype">long</span> m_id;  
00053 };
00054 
<a name="l00055"></a><a class="code" href="class_yard_sale_screen.html#a0">00055</a> <a class="code" href="class_yard_sale_screen.html#a0">YardSaleScreen::YardSaleScreen</a>(wxWindow* parent, wxWindowID id, <span class="keyword">const</span> wxString&amp; title,
00056                    <span class="keyword">const</span> wxPoint&amp; pos, <span class="keyword">const</span> wxSize&amp; size, <span class="keywordtype">long</span> style, <span class="keyword">const</span> wxString&amp; name)
00057 :wxDialog(parent, id, title, pos, size, style, name) {
00058     
00059     wxBusyCursor busy();
00060     wxXmlResource::Get()-&gt;Load(<span class="stringliteral">"res/new_sales_wdr.xrc"</span>);
00061     wxPanel * panel = wxXmlResource::Get()-&gt;LoadPanel(<span class="keyword">this</span>, <span class="stringliteral">"Checkout"</span>);
00062     wxSizer * sizer = panel-&gt;GetSizer();
00063     sizer-&gt;SetSizeHints(<span class="keyword">this</span>);
00064     SetSize(wxSize(600,400));
00065     Centre();
00066     
00067     wxButton * hidden = <span class="keyword">new</span> wxButton(panel, HIDDEN_BUTTON, <span class="stringliteral">""</span>, wxDefaultPosition, wxSize(1,1));
00068     hidden-&gt;SetDefault();
00069     
00070     m_list = static_cast&lt;wxListCtrl *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_SALES_TRANS"</span>)));
00071     m_book = static_cast&lt;wxNotebook *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_SALES_GROUPS"</span>)));
00072    
00073     m_subTotal = static_cast&lt;wxStaticText *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_SALES_SUB"</span>)));
00074     m_tax = static_cast&lt;wxStaticText *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_SALES_TAX"</span>)));
00075     m_total = static_cast&lt;wxStaticText *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_SALES_TOTAL"</span>)));
00076     m_barcode = static_cast&lt;wxTextCtrl *&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_SALES_BARCODE"</span>)));
00077     
00078     wxListItem itemCol;
00079     itemCol.m_mask = wxLIST_MASK_TEXT | wxLIST_MASK_IMAGE;
00080     itemCol.m_text = _T(<span class="stringliteral">"Item"</span>);
00081     itemCol.m_image = -1;
00082     m_list-&gt;InsertColumn(0, itemCol);
00083     itemCol.m_text = _T(<span class="stringliteral">"#"</span>);
00084     m_list-&gt;InsertColumn(1, itemCol);
00085     itemCol.m_text = _T(<span class="stringliteral">"Price"</span>);
00086     m_list-&gt;InsertColumn(2, itemCol);   
00087     
00088     m_list-&gt;SetColumnWidth( 0, wxLIST_AUTOSIZE );
00089     m_list-&gt;SetColumnWidth( 1, wxLIST_AUTOSIZE );
00090     m_list-&gt;SetColumnWidth( 2, wxLIST_AUTOSIZE );
00091     
00092     BuildNotebook(m_book);
00094     vector&lt;YardTaxType&gt; tax;
00095     <span class="keywordflow">try</span> {
00096         tax = wxGetApp().DB().TaxTypeGetAll();
00097     }
00098     <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)
00099     {
00100         wxLogDebug(wxT(<span class="stringliteral">"Error (tax load): %s, %s"</span>),e.what(), e.GetSQL().c_str());
00101         <span class="keywordflow">return</span>;
00102     }
00103     wxLogDebug(wxT(<span class="stringliteral">"Loading %d tax types..."</span>), tax.size());
00104     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; tax.size(); i++)
00105     {
00106         m_taxCache[tax[i].GetId()] = tax[i].GetPercent();
00107     }
00108     
00109 }
00110 
00111 <span class="keywordtype">void</span> YardSaleScreen::OnIdle(wxIdleEvent&amp; event)
00112 {   
00113     m_barcode-&gt;SetFocus();
00114 }
00115 
00116 <span class="keywordtype">void</span> YardSaleScreen::OnHidden(wxCommandEvent &amp; event)
00117 {
00118     wxLogMessage(m_barcode-&gt;GetValue().c_str());
00119     
00120     <a class="code" href="class_yard_inv_type.html">YardInvType</a> temp;
00121     <span class="keywordflow">try</span> {
00122         temp = wxGetApp().DB().InventoryBarcode(m_barcode-&gt;GetValue().c_str());
00123     }
00124     <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)
00125     {
00126         wxLogDebug(wxT(<span class="stringliteral">"Error (item not loaded): %s, %s"</span>),e.what(), e.GetSQL().c_str());
00127         <span class="keywordflow">return</span>;
00128     }
00129 
00130     AddItem(temp);
00131     m_barcode-&gt;SetValue(<span class="stringliteral">""</span>);
00132     
00133 }
00134 
00135 <span class="keywordtype">void</span> YardSaleScreen::AddItem(<span class="keyword">const</span> <a class="code" href="class_yard_inv_type.html">YardInvType</a>&amp; temp)
00136 {
00137     m_items.push_back(temp);
00138  
00139     m_list-&gt;InsertItem(0, temp.<a class="code" href="class_yard_inv_type.html#a5">GetName</a>().c_str(), 0);
00140     m_list-&gt;SetItemData(0, temp.<a class="code" href="class_yard_inv_type.html#a3">GetKey</a>());
00141     m_list-&gt;SetItem(0, 1, <span class="stringliteral">"1"</span>);
00142     m_list-&gt;SetItem(0, 2, temp.<a class="code" href="class_yard_inv_type.html#a24">GetRetailPriceS</a>().c_str());
00143    
00144     m_list-&gt;SetColumnWidth( 0, wxLIST_AUTOSIZE );
00145     m_list-&gt;SetColumnWidth( 1, wxLIST_AUTOSIZE );
00146     m_list-&gt;SetColumnWidth( 2, wxLIST_AUTOSIZE );
00147      
00148     <span class="comment">// calc total</span>
00149     m_sub = 0;
00150     m_totalPrice = 0;
00151     m_taxTotal = 0;
00152     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_items.size(); i++)
00153     {
00154         m_sub += m_items[i].GetRetailPrice();
00155         <span class="keywordtype">long</span> taxid = m_items[i].GetTaxType();
00156         m_taxTotal += m_taxCache[taxid] * m_items[i].GetRetailPrice();
00157     }
00158     m_totalPrice = m_sub + m_taxTotal;
00159     
00160     m_subTotal-&gt;SetLabel(XMLNode::ToStr(m_sub, 2).c_str());
00161     m_tax-&gt;SetLabel(XMLNode::ToStr(m_taxTotal, 2).c_str()); 
00162     m_total-&gt;SetLabel(XMLNode::ToStr(m_sub + m_taxTotal, 2).c_str()); 
00163 
00164 }
00165 
00166 <span class="keywordtype">void</span> YardSaleScreen::OnItem(wxCommandEvent&amp; event)
00167 {
00168     
00169     <span class="keywordtype">long</span> id = event.GetId();
00170     wxLogDebug(wxT(<span class="stringliteral">"ID: %d"</span>), id);
00171     <span class="keywordflow">if</span> (id &lt; START_BUTTON_ID)
00172     {
00173         wxLogDebug(wxT(<span class="stringliteral">"Bad event ID"</span>));
00174         <span class="keywordflow">return</span>;
00175     }
00176     
00177     <a class="code" href="class_yard_inv_type.html">YardInvType</a> temp;
00178     <span class="keywordflow">try</span> {
00179         temp = wxGetApp().DB().InventoryGet(m_lookup[id]);
00180     }
00181     <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)
00182     {
00183         wxLogDebug(wxT(<span class="stringliteral">"Error (item not loaded): %s, %s"</span>),e.what(), e.GetSQL().c_str());
00184         <span class="keywordflow">return</span>;
00185     }
00186       
00187     AddItem(temp);
00188     
00189 }
00190 
00191 <span class="keywordtype">void</span> YardSaleScreen::BuildNotebook(wxNotebook * nb)
00192 {
00193     vector&lt;YardGroup&gt; groups;
00194     
00195     <span class="keywordflow">try</span> {
00196         groups = wxGetApp().DB().GroupGetAll();
00197     }
00198     <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)
00199     {
00200         wxLogDebug(wxT(<span class="stringliteral">"Error (grp load): %s, %s"</span>),e.what(), e.GetSQL().c_str());
00201         <span class="keywordflow">return</span>;
00202     }
00203     
00204     <span class="keywordtype">long</span> id = START_BUTTON_ID;
00205     
00206     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; groups.size(); i++)
00207     {
00208         wxPanel * panel = <span class="keyword">new</span> wxPanel(nb);
00209         wxFlexGridSizer *sizer = <span class="keyword">new</span> wxFlexGridSizer( 3, 0, 0 );
00210                 
00211         vector&lt;YardInvType&gt; items;
00212         <span class="keywordflow">try</span> {
00213             items = wxGetApp().DB().InventoryGetInGroup(groups[i].GetId());
00214         }
00215         <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)            
00216         {
00217             wxLogDebug(wxT(<span class="stringliteral">"Error (item load): %s, %s"</span>),e.what(), e.GetSQL().c_str());
00218             <span class="keywordflow">return</span>;
00219         }
00220         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; items.size(); k++)
00221         {
00222             wxLogDebug(wxT(<span class="stringliteral">"Adding item %s, %d"</span>), items[k].GetType().c_str(), items[k].GetKey());
00223 
00224             m_lookup[id] = items[k].GetKey();
00225             wxButton * button = <span class="keyword">new</span> wxButton(panel, id++ , items[k].GetName().c_str());
00226             wxSize size = button-&gt;GetSize();
00227             
00228             size.SetHeight(SALE_BUTTON_HEIGHT);
00229             button-&gt;SetSize(size);
00230             button-&gt;SetBackgroundColour(*wxBLUE);
00231             sizer-&gt;Add(button,  0, wxALIGN_CENTER|wxALL, 5);
00232             
00233         }
00234         panel-&gt;SetAutoLayout( TRUE );
00235         panel-&gt;SetSizer(sizer);
00236         nb-&gt;AddPage(panel, groups[i].GetName().c_str());
00237     }
00238        
00239 }
00240 
00241 <span class="keywordtype">void</span> YardSaleScreen::OnRemove(wxCommandEvent&amp; event)
00242 {
00243     wxLogDebug(wxT(<span class="stringliteral">"OnRemove"</span>));   
00244 }
00245 
00246 <span class="keywordtype">void</span> YardSaleScreen::OnCheckout(wxCommandEvent&amp; event)
00247 {
00248     wxLogDebug(wxT(<span class="stringliteral">"OnCheckout"</span>));
00249     <a class="code" href="class_yard_checkout.html">YardCheckout</a> * co = <span class="keyword">new</span> <a class="code" href="class_yard_checkout.html">YardCheckout</a>(<span class="keyword">this</span>, -1, wxT(<span class="stringliteral">"Checkout"</span>));
00250     co-&gt;<a class="code" href="class_yard_checkout.html#a3">SetInvRef</a>(&amp;m_items);
00251     co-&gt;<a class="code" href="class_yard_checkout.html#a2">SetCost</a>(m_sub, m_taxTotal, m_totalPrice);
00252     <span class="keywordflow">if</span> (co-&gt;ShowModal() == 0)
00253     {
00254         co-&gt;Destroy();
00255         EndModal(0);
00256     }
00257     co-&gt;Destroy();
00258 }
00259 
<a name="l00260"></a><a class="code" href="class_yard_sale_screen.html#a1">00260</a> <a class="code" href="class_yard_sale_screen.html#a1">YardSaleScreen::~YardSaleScreen</a>()
00261 {
00262     
00263 }
00264 
<a name="l00265"></a><a class="code" href="class_yard_sale_screen.html#a2">00265</a> <span class="keywordtype">void</span> <a class="code" href="class_yard_sale_screen.html#a2">YardSaleScreen::OnExitButton</a>(wxCommandEvent &amp; event)
00266 {
00267     wxLogDebug(wxT(<span class="stringliteral">"YardSaleScreen::OnExitButton"</span>));
00268     EndModal(0);
00269 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun May 9 23:08:00 2004 for YardSale by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
