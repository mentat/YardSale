<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>YardSale: yardsale.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>yardsale.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include "wx/wx.h"</span>
00002 <span class="preprocessor">#include "wx/config.h"</span>
00003 <span class="preprocessor">#include "wx/fs_zip.h"</span>
00004 <span class="preprocessor">#include "extra/xrc/xmlres.h"</span>
00005 
00006 <span class="preprocessor">#include "yardsale.h"</span>
00007 <span class="preprocessor">#include "ys_splash.h"</span>
00008 <span class="preprocessor">#include "ys_main.h"</span>
00009 <span class="preprocessor">#include "ys_login.h"</span>
00010 <span class="preprocessor">#include "ys_exception.h"</span>
00011 <span class="preprocessor">#include "ys_database.h"</span>
00012 <span class="preprocessor">#include "ys_log.h"</span>
00013 <span class="preprocessor">#include "ys_config.h"</span>
00014 
00015 IMPLEMENT_APP(<a class="code" href="class_yard_sale.html">YardSale</a>)
00016 
<a name="l00017"></a><a class="code" href="class_yard_sale.html#a0">00017</a> <span class="keywordtype">bool</span> <a class="code" href="class_yard_sale.html#a0">YardSale::OnInit</a>()
00018 {
00019     SetVendorName(_T(<span class="stringliteral">"ASLS"</span>));
00020     SetAppName(_T(<span class="stringliteral">"YardSale"</span>));
00021     
00022     m_full = <span class="keyword">false</span>;
00023     m_db = 0;
00024     m_db = <span class="keyword">new</span> <a class="code" href="class_yard_database.html">YardDatabase</a>();
00025     
00026     wxImage::AddHandler(<span class="keyword">new</span> wxPNGHandler);
00027     wxImage::Adok idHandler(<span class="keyword">new</span> wxJPEGHandler);     
00028     wxFileSystem::AddHandler(<span class="keyword">new</span> wxZipFSHandler);
00029     wxXmlResource::Get()-&gt;InitAllHandlers();
00030 
00031     <span class="keywordflow">if</span> (!<a class="code" href="class_yard_sale.html#a4">ShowLogin</a>())
00032     {
00033         <span class="keyword">delete</span> m_db;
00034         <span class="keyword">delete</span> wxConfigBase::Set((wxConfigBase *) NULL);
00035         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00036     }
00037     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00038 }
00039 
<a name="l00040"></a><a class="code" href="class_yard_sale.html#a4">00040</a> <span class="keywordtype">bool</span> <a class="code" href="class_yard_sale.html#a4">YardSale::ShowLogin</a>(wxWindow * old)
00041 {
00042     <a class="code" href="class_yard_login.html">YardLogin</a> * login = <span class="keyword">new</span> <a class="code" href="class_yard_login.html">YardLogin</a>(NULL, -1, <span class="stringliteral">"YardSale"</span>);
00043     SetTopWindow(login);
00044     
00045     <span class="keywordflow">if</span> (old) <span class="comment">// kill old session</span>
00046     {
00047         <a class="code" href="class_yard_sale.html#a2">DB</a>().<a class="code" href="class_yard_database.html#a5">disconnect</a>();
00048         old-&gt;Destroy();
00049     }
00050     
00051     <span class="keywordflow">do</span> { <span class="comment">// we keep the user at the login screen until they login</span>
00052         <span class="keywordflow">if</span> (login-&gt;ShowModal() == 1)
00053         {
00054             login-&gt;Destroy();
00055             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00056         }
00058         m_user = login-&gt;<a class="code" href="class_yard_login.html#a5">GetUser</a>();
00059         m_pass = login-&gt;<a class="code" href="class_yard_login.html#a6">GetPass</a>();
00060     } <span class="keywordflow">while</span>( !(LoadConfig() &amp;&amp; TryLogin()) );            
00061 
00062     login-&gt;Destroy();
00063     
00065     wxFrame * frame = <span class="keyword">new</span> <a class="code" href="class_yard_main.html">YardMain</a>(NULL, -1, <span class="stringliteral">"YardSale"</span>);
00066     
00067     frame-&gt;Show(<span class="keyword">true</span>);
00068     SetTopWindow(frame);
00069     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00070     
00071 }
00072 
00073 <span class="keywordtype">bool</span> YardSale::TryLogin()
00074 {
00075     wxConfigBase *pConfig = wxConfigBase::Get();
00076     wxLogDebug(wxT(<span class="stringliteral">"Trying to login..."</span>));
00077     
00078     <span class="comment">//wxString user = pConfig-&gt;Read(wxT("/DB/User"), wxString());</span>
00079     <span class="comment">//wxString pass = pConfig-&gt;Read(wxT("/DB/Pass"), wxString());</span>
00080     wxString dsn = pConfig-&gt;Read(wxT(<span class="stringliteral">"/DB/DSN"</span>), wxString());
00081 
00082     <span class="keywordflow">try</span> {
00083         <a class="code" href="class_yard_sale.html#a2">DB</a>().<a class="code" href="class_yard_database.html#a2">Init</a>(m_user.c_str(), m_pass.c_str(), dsn.c_str());
00084     } <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a> &amp;e) {
00085         wxLogDebug(e.GetWhat().c_str());
00086         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00087     }
00088     
00089     <span class="keywordflow">try</span> { 
00090         <a class="code" href="class_yard_sale.html#a2">DB</a>().<a class="code" href="class_yard_database.html#a4">connect</a>();  
00091     } <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a> &amp;e) {
00092         wxLogDebug(e.GetWhat().c_str());
00093         wxString reason;
00094         reason.Printf(wxT(<span class="stringliteral">"Could not connect to the database:\n%s"</span>), 
00095             e.GetWhat().c_str());
00096         wxMessageBox(reason, wxT(<span class="stringliteral">"Connection Error"</span>));
00097         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00098     }
00099     wxLogDebug(wxT(<span class="stringliteral">"Connected to %s"</span>), dsn.c_str());
00100     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00101 }
00102 
00103 <span class="keywordtype">bool</span> YardSale::LoadConfig()
00104 {
00105     wxConfigBase *pConfig = wxConfigBase::Get();
00106 
00107     <span class="keywordflow">if</span> (!pConfig)
00108     {
00109         wxLogError(wxT(<span class="stringliteral">"No Config pointer"</span>));
00110         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00111     } 
00112     <span class="keywordflow">else</span>
00113         <span class="keywordflow">if</span> (!pConfig-&gt;HasGroup(wxT(<span class="stringliteral">"DB"</span>)))
00114         {
00115             wxLogDebug(wxT(<span class="stringliteral">"No DB group in config."</span>));
00116             <span class="keywordtype">int</span> answer = wxMessageBox(
00117                 <span class="stringliteral">"No configuration exists on this computer,\n"</span>
00118                 <span class="stringliteral">"would you like to create one? You will\n"</span>
00119                 <span class="stringliteral">"be unable to login without a configuration"</span>, <span class="stringliteral">"Create Config"</span>,
00120                                 wxYES_NO);
00121             <span class="keywordflow">if</span> (answer == wxNO)
00122             {
00123                 wxLogDebug(wxT(<span class="stringliteral">"Answer was no."</span>));
00124                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00125             }
00126             <span class="keywordflow">else</span>
00127             {
00128                 <a class="code" href="class_yard_config.html">YardConfig</a> * conf = <span class="keyword">new</span> <a class="code" href="class_yard_config.html">YardConfig</a>(NULL, -1, wxT(<span class="stringliteral">"YardSale Configuration"</span>));
00129                 conf-&gt;ShowModal();
00130                 conf-&gt;Destroy();
00131             }
00132         }
00133         <span class="keywordflow">else</span> wxLogDebug(wxT(<span class="stringliteral">"Config found, reading..."</span>));
00134 
00135     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00136 }
00137 
<a name="l00138"></a><a class="code" href="class_yard_sale.html#a1">00138</a> <span class="keywordtype">int</span> <a class="code" href="class_yard_sale.html#a1">YardSale::OnExit</a>() {
00139     <span class="keyword">delete</span> wxConfigBase::Set((wxConfigBase *) NULL);
00140     <span class="keyword">delete</span> m_db;
00141     <span class="keywordflow">return</span> 0;
00142 }
00143 
<a name="l00144"></a><a class="code" href="class_yard_sale.html#a2">00144</a> <a class="code" href="class_yard_database.html">YardDatabase</a>&amp; <a class="code" href="class_yard_sale.html#a2">YardSale::DB</a>() {
00145     
00146     <span class="keywordflow">if</span> (!m_db)
00147         <span class="keywordflow">throw</span> <a class="code" href="class_yard_exception.html">YardException</a>(<span class="stringliteral">"Database not allocated."</span>);
00148     
00149     <span class="keywordflow">return</span> *m_db;
00150 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun May 9 23:07:58 2004 for YardSale by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
