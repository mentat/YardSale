<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>YardSale: ys_reports.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>ys_reports.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;string&gt;</span>
00002 
00003 <span class="preprocessor">#include "extra/xrc/xmlres.h"</span>
00004 <span class="preprocessor">#include "wx/wx.h"</span>
00005 <span class="preprocessor">#include "wx/app.h"</span>
00006 <span class="preprocessor">#include "wx/calctrl.h"</span>
00007 <span class="preprocessor">#include "wx/html/htmlwin.h"</span>
00008 <span class="preprocessor">#include "wx/html/htmprint.h"</span>
00009 
00010 <span class="preprocessor">#include "yardsale.h"</span>
00011 <span class="preprocessor">#include "ys_database.h"</span>
00012 <span class="preprocessor">#include "ys_date.h"</span>
00013 <span class="preprocessor">#include "ys_reports.h"</span>
00014 <span class="preprocessor">#include "xmlnode.h"</span>
00015 <span class="preprocessor">#include "sablot.h"</span>
00016 
00017 <span class="comment">// testing: gdc</span>
00018 <span class="preprocessor">#ifdef YS_CHART</span>
00019 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00020 <span class="preprocessor">#include "extra/gdc/gdc.h"</span>
00021 <span class="preprocessor">#include "extra/gdc/gdcpie.h"</span>
00022 }
00023 <span class="preprocessor">#endif</span>
00024 <span class="preprocessor"></span>
00025 DECLARE_APP(<a class="code" href="class_yard_sale.html">YardSale</a>)
00026 
00027 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00028 
00029 <span class="keyword">enum</span> { ID_HTML_PAGESETUP = 13500, ID_HTML_PRINTSETUP, ID_HTML_PRINT,
00030         ID_HTML_PREVIEW, ID_HTML_QUIT };
00031 
00032 <span class="keyword">class </span>YardHTML: <span class="keyword">public</span> wxDialog
00033 {
00034  <span class="keyword">public</span>:
00035     YardHTML(wxWindow* parent, wxWindowID id, <span class="keyword">const</span> wxString&amp; title,
00036                <span class="keyword">const</span> wxPoint&amp; pos = wxDefaultPosition, 
00037                <span class="keyword">const</span> wxSize&amp; size = wxDefaultSize,
00038                <span class="keywordtype">long</span> style = wxDEFAULT_FRAME_STYLE,
00039                <span class="keyword">const</span> wxString&amp; name = wxT(<span class="stringliteral">"YardHTML"</span>))
00040     :wxDialog(parent, id, title, pos, size, style, name)
00041     {
00042         
00043         wxPanel * panel = <span class="keyword">new</span> wxPanel(<span class="keyword">this</span>);
00044         m_html = <span class="keyword">new</span> wxHtmlWindow(panel, -1, wxDefaultPosition, wxSize(480,350),
00045             wxSUNKEN_BORDER | wxHW_SCROLLBAR_AUTO );
00046        
00047         wxButton * preview = <span class="keyword">new</span> wxButton(panel, ID_HTML_PREVIEW, <span class="stringliteral">"Preview"</span>, wxDefaultPosition);
00048         wxButton * page_setup = <span class="keyword">new</span> wxButton(panel, ID_HTML_PAGESETUP, <span class="stringliteral">"Page Setup"</span>, wxDefaultPosition);
00049         wxButton * print_setup = <span class="keyword">new</span> wxButton(panel, ID_HTML_PRINTSETUP, <span class="stringliteral">"Print Setup"</span>, wxDefaultPosition);
00050         wxButton * print = <span class="keyword">new</span> wxButton(panel, ID_HTML_PRINT, <span class="stringliteral">"Print"</span>, wxDefaultPosition);
00051         wxButton * quit = <span class="keyword">new</span> wxButton(panel, ID_HTML_QUIT, <span class="stringliteral">"Quit"</span>, wxDefaultPosition);
00052       
00053         wxBoxSizer * butts = <span class="keyword">new</span> wxBoxSizer(wxHORIZONTAL);
00054         butts-&gt;Add(preview);
00055         butts-&gt;Add(page_setup);
00056         butts-&gt;Add(print_setup);
00057         butts-&gt;Add(print);
00058         butts-&gt;Add(quit);
00059         
00060         wxFlexGridSizer *item0 = <span class="keyword">new</span> wxFlexGridSizer( 1, 0, 0 );
00061         item0-&gt;AddGrowableCol( 0 );
00062         item0-&gt;AddGrowableRow( 0 );
00063         item0-&gt;Add( m_html, 0, wxGROW|wxALIGN_CENTER_VERTICAL, 5 );
00064         item0-&gt;Add( butts, 0, wxGROW|wxALIGN_CENTER_VERTICAL, 5 );
00065         panel-&gt;SetAutoLayout( TRUE );
00066         panel-&gt;SetSizer( item0 );
00067         
00068         m_Prn = <span class="keyword">new</span> wxHtmlEasyPrinting(_(<span class="stringliteral">"YardSale Report"</span>), NULL);
00069         m_Prn -&gt; SetHeader(m_Name + wxT(<span class="stringliteral">"(@PAGENUM@/@PAGESCNT@)&lt;hr&gt;"</span>), wxPAGE_ALL);
00070 
00071         item0-&gt;SetSizeHints(<span class="keyword">this</span>);
00072         SetSize(item0-&gt;GetMinSize());  
00073         Centre();        
00074         <span class="keywordflow">if</span> (wxGetApp().Full())
00075             ShowFullScreen(<span class="keyword">true</span>);
00076         
00077     }
00078     ~YardHTML() { <span class="keyword">delete</span> m_Prn; }
00079     
00080     <span class="keywordtype">void</span> OnPrintSetup(wxCommandEvent&amp; event)
00081     { m_Prn -&gt; PrinterSetup(); }
00082     <span class="keywordtype">void</span> OnPageSetup(wxCommandEvent&amp; event)
00083     { m_Prn -&gt; PageSetup(); }
00084     <span class="keywordtype">void</span> OnPrint(wxCommandEvent&amp; event)
00085     { m_Prn -&gt; PrintText(m_Name); }
00086     <span class="keywordtype">void</span> OnPreview(wxCommandEvent&amp; event)
00087     { m_Prn -&gt; PreviewText(m_Name); }
00088     <span class="keywordtype">void</span> OnQuit(wxCommandEvent&amp; event)
00089     { Close(TRUE); }
00090    <span class="comment">/* void OnMenu(wxMouseEvent&amp; event)</span>
00091 <span class="comment">    {</span>
00092 <span class="comment">        wxLogDebug(wxT("OnRight"));</span>
00093 <span class="comment">        wxMenu menuFile(wxT("Printing Menu"));</span>
00094 <span class="comment">        menuFile.Append(ID_HTML_PAGESETUP, _("Page Setup"));</span>
00095 <span class="comment">        menuFile.Append(ID_HTML_PRINTSETUP, _("Printer Setup"));</span>
00096 <span class="comment">        menuFile.Append(ID_HTML_PRINT, _("Print..."));</span>
00097 <span class="comment">        menuFile.Append(ID_HTML_PREVIEW, _("Preview..."));</span>
00098 <span class="comment">        menuFile.AppendSeparator();</span>
00099 <span class="comment">        menuFile.Append(ID_HTML_QUIT, _("&amp;Exit"));</span>
00100 <span class="comment">        wxPoint pt = event.GetPosition();</span>
00101 <span class="comment">        PopupMenu(&amp;menuFile, pt);</span>
00102 <span class="comment">    }*/</span>
00103     <span class="keywordtype">void</span> SetPage(<span class="keyword">const</span> wxString&amp; html) { m_Name = html; m_html-&gt;SetPage(html); }
00104     
00105    
00106  <span class="keyword">private</span>:
00107     wxString m_Name; <span class="comment">// the html to display/print</span>
00108     wxHtmlEasyPrinting *m_Prn;
00109     wxHtmlWindow * m_html;     
00110     DECLARE_EVENT_TABLE()
00111 };
00112 
00113 BEGIN_EVENT_TABLE(YardHTML, wxDialog)
00114     EVT_BUTTON(ID_HTML_QUIT, YardHTML::OnQuit)
00115     EVT_BUTTON(ID_HTML_PRINT, YardHTML::OnPrint)
00116     EVT_BUTTON(ID_HTML_PREVIEW, YardHTML::OnPreview)
00117     EVT_BUTTON(ID_HTML_PAGESETUP, YardHTML::OnPageSetup)
00118     EVT_BUTTON(ID_HTML_PRINTSETUP, YardHTML::OnPrintSetup)
00119 END_EVENT_TABLE()
00120 
00121 
00122 BEGIN_EVENT_TABLE(<a class="code" href="class_yard_reports.html">YardReports</a>, wxDialog)
00123     EVT_BUTTON(XRCID(<span class="stringliteral">"ID_REPORT_EMP_HOURS"</span>), YardReports::OnReportEmpHours)
00124     EVT_BUTTON(XRCID(<span class="stringliteral">"ID_REPORT_EMP_SALES"</span>), YardReports::OnReportEmpSales)
00125     EVT_BUTTON(XRCID(<span class="stringliteral">"ID_REPORT_HOURLY_REV"</span>), YardReports::OnReportHourlyRev)
00126     EVT_BUTTON(XRCID(<span class="stringliteral">"ID_REPORT_LEAVE"</span>), YardReports::OnLeave)
00127 END_EVENT_TABLE()
00128 
<a name="l00129"></a><a class="code" href="class_yard_reports.html#a0">00129</a> <a class="code" href="class_yard_reports.html#a0">YardReports::YardReports</a>(wxWindow* parent, wxWindowID id, <span class="keyword">const</span> wxString&amp; title,
00130                <span class="keyword">const</span> wxPoint&amp; pos,<span class="keyword">const</span> wxSize&amp; size, <span class="keywordtype">long</span> style,
00131                <span class="keyword">const</span> wxString&amp; name): wxDialog(parent, id, title, pos, size, style, name)
00132 {
00133     wxBusyCursor busy();
00134     wxXmlResource::Get()-&gt;Load(<span class="stringliteral">"res/reports.xrc"</span>);
00135     wxPanel * panel = wxXmlResource::Get()-&gt;LoadPanel(<span class="keyword">this</span>, <span class="stringliteral">"Reports"</span>);
00136     wxSizer * sizer = panel-&gt;GetSizer();
00137     sizer-&gt;SetSizeHints(<span class="keyword">this</span>);
00138     SetSize(sizer-&gt;GetMinSize());  
00139     Centre();    
00140     <span class="keywordflow">if</span> (wxGetApp().Full())
00141         ShowFullScreen(<span class="keyword">true</span>);
00142     
00143     m_to = static_cast&lt;wxCalendarCtrl*&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_REPORT_TO"</span>)));
00144     m_to-&gt;SetHighlightColours(*wxRED, *wxBLACK); 
00145     m_from = static_cast&lt;wxCalendarCtrl*&gt;(FindWindow(XRCID(<span class="stringliteral">"ID_REPORT_FROM"</span>)));
00146     m_from-&gt;SetHighlightColours(*wxRED, *wxBLACK); 
00147 }
00148 
<a name="l00149"></a><a class="code" href="class_yard_reports.html#a1">00149</a> <a class="code" href="class_yard_reports.html#a1">YardReports::~YardReports</a>() {}
00150     
00151 <span class="keywordtype">void</span> YardReports::OnReportEmpHours(wxCommandEvent&amp; event)
00152 {
00153     YardDate to(m_to-&gt;GetDate());
00154     YardDate from(m_from-&gt;GetDate());
00155     
00156     stringstream sql;
00157     sql &lt;&lt; <span class="stringliteral">"SELECT EMP_ID_Number AS ID_Number , EMP_First_Name AS First_Name, Emp_Last_Name AS Last_Name, "</span>
00158             <span class="stringliteral">"EXTRACT(HOUR FROM LOG_Time_Out - LOG_Time_In) AS Time_Worked_Hours, "</span>
00159             <span class="stringliteral">"EXTRACT(HOUR_MINUTE FROM LOG_Time_Out - LOG_Time_In)%100 AS Time_Worked_Minutes, "</span>
00160             <span class="stringliteral">"DATE_FORMAT(Log_Time_Out, '%W %M %D' ) AS Worked_On_Date "</span>
00161             <span class="stringliteral">"FROM Login_Table JOIN Employee_Table ON LOG_REF_EMP_ID = EMP_ID_Number "</span>
00162             <span class="stringliteral">"WHERE LOG_Count = 0 AND "</span>
00163             <span class="stringliteral">"LOG_Time_In BETWEEN '"</span> &lt;&lt; from.DayString() &lt;&lt; <span class="stringliteral">"' AND '"</span> 
00164             &lt;&lt; to.DayString() &lt;&lt; <span class="stringliteral">"'; "</span>;
00165     
00166     string xml(<span class="stringliteral">"&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n"</span>
00167                 <span class="stringliteral">"&lt;root&gt;\n"</span>);
00168     
00169     <span class="keywordtype">long</span> count = 0;
00170     <span class="keywordflow">try</span>
00171     {
00172         xml += wxGetApp().DB().ReportXML(sql.str(), count);
00173     }
00174     <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)
00175     {
00176         wxLogDebug(wxT(<span class="stringliteral">"Error (report): %s, %s"</span>),e.what(), e.GetSQL().c_str());
00177         <span class="keywordflow">return</span>;
00178     }
00179     wxLogDebug(wxT(<span class="stringliteral">"Count: %d"</span>), count);
00180     
00181     <span class="keywordflow">if</span> (count == 0)
00182     {
00183         wxMessageBox(<span class="stringliteral">"No data was found in that time range."</span>, <span class="stringliteral">"No Data"</span>,
00184                             wxOK, <span class="keyword">this</span>);   
00185         <span class="keywordflow">return</span>;
00186     }
00187     
00188     xml += <span class="stringliteral">"\n&lt;/root&gt;\n"</span>;
00189     
00190     string html = ProcessXSLT(xml, <span class="stringliteral">"res/report.xsl"</span>);
00191     
00192     YardHTML * prev = <span class="keyword">new</span> YardHTML(<span class="keyword">this</span>, -1, wxT(<span class="stringliteral">"Report Preview"</span>));
00193     prev-&gt;SetPage(html.c_str());
00194     prev-&gt;ShowModal();
00195     prev-&gt;Destroy();
00196 }
00197 <span class="keywordtype">void</span> YardReports::OnReportEmpSales(wxCommandEvent&amp; event)
00198 {
00199     
00200     YardDate to(m_to-&gt;GetDate());
00201     YardDate from(m_from-&gt;GetDate());
00202     
00203     stringstream sql;
00204     sql &lt;&lt; <span class="stringliteral">"SELECT TRANS_REF_EMP_ID_Number AS Employee_ID, "</span>
00205            <span class="stringliteral">"EMP_First_Name AS First_Name, EMP_Last_Name AS Last_Name, "</span>
00206            <span class="stringliteral">"SUM((TRANS_Quantity * (TRANS_Sale_Price - INV_Wholesale_Price))) AS PROFIT, "</span>
00207            <span class="stringliteral">"SUM(TRANS_Sale_Price * TRANS_Quantity) AS RETAIL_TOTAL, "</span>
00208            <span class="stringliteral">"SUM(INV_Wholesale_Price * TRANS_Quantity) AS TOTAL_WHOLESALE_COST "</span>
00209            <span class="stringliteral">"FROM Transaction_Log_Table JOIN Employee_Table "</span>
00210            <span class="stringliteral">"ON Transaction_Log_Table.TRANS_REF_EMP_ID_Number = Employee_Table.EMP_ID_Number  JOIN Customer_Table "</span>
00211            <span class="stringliteral">"ON Transaction_Log_Table.TRANS_REF_CUST_Account_Number = Customer_Table.Cust_Account_Number JOIN Inventory_Table "</span>
00212            <span class="stringliteral">"ON Transaction_Log_Table.TRANS_REF_INV_Item_ID = Inventory_Table.INV_Item_ID "</span>
00213            <span class="stringliteral">"WHERE "</span>
00214            <span class="stringliteral">"TRANS_Time BETWEEN '"</span>
00215            &lt;&lt; from.ToString() &lt;&lt; <span class="stringliteral">"' AND '"</span> &lt;&lt; to.ToString() &lt;&lt; <span class="stringliteral">"' "</span>
00216            <span class="stringliteral">"GROUP BY TRANS_REF_EMP_ID_Number;"</span>;
00217     
00218     string xml(<span class="stringliteral">"&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n"</span>
00219                 <span class="stringliteral">"&lt;root&gt;\n"</span>);
00220     
00221     <span class="keywordtype">long</span> count = 0;
00222     <span class="keywordflow">try</span>
00223     {
00224         xml += wxGetApp().DB().ReportXML(sql.str(), count);
00225     }
00226     <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)
00227     {
00228         wxLogDebug(wxT(<span class="stringliteral">"Error (report): %s, %s"</span>),e.what(), e.GetSQL().c_str());
00229         <span class="keywordflow">return</span>;
00230     }
00231     wxLogDebug(wxT(<span class="stringliteral">"Count: %d"</span>), count);
00232     
00233     <span class="keywordflow">if</span> (count == 0)
00234     {
00235         wxMessageBox(<span class="stringliteral">"No data was found in that time range."</span>, <span class="stringliteral">"No Data"</span>,
00236                             wxOK, <span class="keyword">this</span>);   
00237         <span class="keywordflow">return</span>;
00238     }
00239     
00240     xml += <span class="stringliteral">"\n&lt;/root&gt;\n"</span>;
00241     
00242     GenerateGraph(xml,<span class="stringliteral">"Last_Name"</span>, <span class="stringliteral">"PROFIT"</span>); 
00243     
00244     string html = ProcessXSLT(xml, <span class="stringliteral">"res/report_employee_sales.xsl"</span>);
00245     
00246     YardHTML * prev = <span class="keyword">new</span> YardHTML(<span class="keyword">this</span>, -1, wxT(<span class="stringliteral">"Report Preview"</span>));
00247     prev-&gt;SetPage(html.c_str());
00248     prev-&gt;ShowModal();
00249     prev-&gt;Destroy();
00250     
00251 }
00252 
00253 <span class="keywordtype">void</span> YardReports::OnReportHourlyRev(wxCommandEvent&amp; event)
00254 {
00255 
00256     YardDate to(m_to-&gt;GetDate());
00257     YardDate from(m_from-&gt;GetDate());
00258     
00259     stringstream sql;
00260     sql &lt;&lt; <span class="stringliteral">"SELECT EXTRACT(HOUR FROM TRANS_Time) AS Hour, "</span>
00261            <span class="stringliteral">"SUM((TRANS_Quantity * (TRANS_Sale_Price - INV_Wholesale_Price))) AS PROFIT "</span>
00262            <span class="stringliteral">"FROM Transaction_Log_Table  JOIN Inventory_Table "</span>
00263            <span class="stringliteral">"ON Transaction_Log_Table.TRANS_REF_INV_Item_ID = Inventory_Table.INV_Item_ID "</span>
00264            <span class="stringliteral">"WHERE "</span>
00265            <span class="stringliteral">"TRANS_Time BETWEEN '"</span>
00266            &lt;&lt; from.ToString() &lt;&lt; <span class="stringliteral">"' AND '"</span> &lt;&lt; to.ToString() &lt;&lt; <span class="stringliteral">"' "</span>
00267            <span class="stringliteral">"GROUP BY EXTRACT(HOUR FROM TRANS_Time) "</span>
00268            <span class="stringliteral">"UNION "</span>
00269            <span class="stringliteral">"SELECT EXTRACT(HOUR FROM TRANS_Time)  AS Hour,  "</span>
00270            <span class="stringliteral">"SUM((TRANS_Quantity * (TRANS_Sale_Price - INV_Wholesale_Price))) AS PROFIT "</span>
00271            <span class="stringliteral">"FROM Transaction_Log_Table  JOIN Inventory_Table "</span>
00272            <span class="stringliteral">"ON Transaction_Log_Table.TRANS_REF_INV_Item_ID = Inventory_Table.INV_Item_ID "</span>
00273            <span class="stringliteral">"WHERE "</span>
00274            <span class="stringliteral">"TRANS_Time BETWEEN '"</span>
00275            &lt;&lt; from.ToString() &lt;&lt; <span class="stringliteral">"' AND '"</span> &lt;&lt; to.ToString() &lt;&lt; <span class="stringliteral">"' "</span>
00276            <span class="stringliteral">"GROUP BY TRANS_Always_Null;"</span>;
00277     
00278     string xml(<span class="stringliteral">"&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n"</span>
00279                 <span class="stringliteral">"&lt;root&gt;\n"</span>);
00280     
00281     <span class="keywordtype">long</span> count = 0;
00282     <span class="keywordflow">try</span>
00283     {
00284         xml += wxGetApp().DB().ReportXML(sql.str(), count);
00285     }
00286     <span class="keywordflow">catch</span> (<a class="code" href="class_yard_d_b_exception.html">YardDBException</a>&amp; e)
00287     {
00288         wxLogDebug(wxT(<span class="stringliteral">"Error (report): %s, %s"</span>),e.what(), e.GetSQL().c_str());
00289         <span class="keywordflow">return</span>;
00290     }
00291     wxLogDebug(wxT(<span class="stringliteral">"Count: %d"</span>), count);
00292     
00293     <span class="keywordflow">if</span> (count == 0)
00294     {
00295         wxMessageBox(<span class="stringliteral">"No data was found in that time range."</span>, <span class="stringliteral">"No Data"</span>,
00296                             wxOK, <span class="keyword">this</span>);   
00297         <span class="keywordflow">return</span>;
00298     }
00299     
00300     xml += <span class="stringliteral">"\n&lt;/root&gt;\n"</span>;
00301     
00302     GenerateGraph(xml,<span class="stringliteral">"HOUR"</span>, <span class="stringliteral">"PROFIT"</span>); 
00303     
00304     string html = ProcessXSLT(xml, <span class="stringliteral">"res/report_hourly_profit.xsl"</span>);
00305     
00306     YardHTML * prev = <span class="keyword">new</span> YardHTML(<span class="keyword">this</span>, -1, wxT(<span class="stringliteral">"Report Preview"</span>));
00307     prev-&gt;SetPage(html.c_str());
00308     prev-&gt;ShowModal();
00309     prev-&gt;Destroy();    
00310  
00311 }    
00312     
00313 string YardReports::ProcessXSLT(<span class="keyword">const</span> string&amp; xml_str, <span class="keyword">const</span> string&amp; xsl_file)
00314 {
00315     string ret;
00316     <span class="keywordflow">try</span> {
00317         SablotSituation S;
00318         SablotHandle proc; 
00319         SDOM_Document xml;
00320     
00321         SablotCreateSituation(&amp;S);
00322        <span class="comment">// SablotParseStylesheetBuffer(S, xslt_str.str().c_str(), &amp;xsl);</span>
00323         SablotParseBuffer(S, xml_str.c_str(), &amp;xml);
00324     
00325         SablotCreateProcessorForSituation(S, &amp;proc);
00326        <span class="comment">// SablotAddArgTree(S, proc, "sheet", xsl);</span>
00327         SablotAddArgTree(S, proc, <span class="stringliteral">"data"</span>, xml);
00328     
00329         SablotRunProcessorGen(S, proc, xsl_file.c_str(), <span class="stringliteral">"arg:/data"</span>, <span class="stringliteral">"arg:/out"</span>);
00330     
00331         <span class="keywordtype">char</span> * result;
00332         SablotGetResultArg(proc, <span class="stringliteral">"arg:/out"</span>, &amp;result);
00333         ret = result;
00334             
00335         SablotFree(result);
00336         SablotDestroyDocument(S, xml);
00337         SablotDestroyProcessor(proc);
00338         SablotDestroySituation(S);
00339     }
00340     <span class="keywordflow">catch</span> (...)
00341     {
00342         wxLogDebug(<span class="stringliteral">"Sablot exception..."</span>);
00343     }
00344     
00345     <span class="keywordflow">return</span> ret;
00346 }
00347 
00348 <span class="keywordtype">void</span> YardReports::GenerateGraph(<span class="keyword">const</span> string&amp; xml, <span class="keyword">const</span> string&amp; labelname, 
00349     <span class="keyword">const</span> string&amp; data)
00350 {
00351 <span class="preprocessor">#ifdef YS_CHART</span>
00352 <span class="preprocessor"></span>    wxLogDebug(wxT(<span class="stringliteral">"Creating chart..."</span>));
00353     <a class="code" href="class_x_m_l_node.html">XMLNode</a> node(xml, XMLNode::Str);
00354     
00355     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numlabels = node.<a class="code" href="class_x_m_l_node.html#a13">numChildren</a>(<span class="stringliteral">"record"</span>);
00356     
00357     wxLogDebug(wxT(<span class="stringliteral">"%d labels."</span>), numlabels);
00358     
00359     <span class="keywordtype">char</span> ** labels = <span class="keyword">new</span> <span class="keywordtype">char</span>*[numlabels];
00360     <span class="keywordtype">float</span> * fl_data = <span class="keyword">new</span> <span class="keywordtype">float</span>[numlabels];
00361     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numlabels; i++)
00362     {
00363         labels[i] = <span class="keyword">new</span> <span class="keywordtype">char</span>[node.<a class="code" href="class_x_m_l_node.html#a17">child</a>(<span class="stringliteral">"record"</span>, i).<a class="code" href="class_x_m_l_node.html#a17">child</a>(labelname).<a class="code" href="class_x_m_l_node.html#a7">data</a>().length() + 1];
00364         strcpy(labels[i], node.<a class="code" href="class_x_m_l_node.html#a17">child</a>(<span class="stringliteral">"record"</span>, i).<a class="code" href="class_x_m_l_node.html#a17">child</a>(labelname).<a class="code" href="class_x_m_l_node.html#a7">data</a>().c_str());
00365         labels[i][node.<a class="code" href="class_x_m_l_node.html#a17">child</a>(<span class="stringliteral">"record"</span>, i).<a class="code" href="class_x_m_l_node.html#a17">child</a>(labelname).<a class="code" href="class_x_m_l_node.html#a7">data</a>().length()]=<span class="charliteral">'\0'</span>;
00366         
00367         fl_data[i] = <a class="code" href="class_x_m_l_node.html#e2">XMLNode::ToDouble</a>(node.<a class="code" href="class_x_m_l_node.html#a17">child</a>(<span class="stringliteral">"record"</span>, i).<a class="code" href="class_x_m_l_node.html#a17">child</a>(data).<a class="code" href="class_x_m_l_node.html#a7">data</a>());
00368        
00369         wxLogDebug(wxT(<span class="stringliteral">"Label: %s, Data: %f"</span>), labels[i], fl_data[i]);
00370     }
00371 
00372 
00373     FILE        *fp = fopen( <span class="stringliteral">"res/report.png"</span>, <span class="stringliteral">"wb"</span> );
00374 
00375     <span class="comment">/* colors */</span>
00376     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   clr[] = { 0xFF4040L, 0x80FF80L, 0x8080FFL, 0xFF80FFL, 0xFFFF80L, 0x80FFFFL, 0x0080FFL };
00377 
00378     <span class="comment">/* set options  */</span>
00379     <span class="comment">/* a lot of options are set here for illustration */</span>
00380     <span class="comment">/* none need be - see gdcpie.h for defaults */</span>
00381     GDCPIE_title = <span class="stringliteral">"YardSale Report"</span>; 
00382     GDCPIE_label_line = TRUE;
00383     GDCPIE_label_dist = 15;             <span class="comment">/* dist. labels to slice edge */</span>
00384                                         <span class="comment">/* can be negative */</span>
00385     GDCPIE_LineColor = 0x000000L;
00386     GDCPIE_label_size = GDC_SMALL;
00387     GDCPIE_3d_depth  = 25;
00388     GDCPIE_3d_angle  = 180;             <span class="comment">/* 0 - 359 */</span>
00389     GDCPIE_perspective = 70;                <span class="comment">/* 0 - 99 */</span>
00390     <span class="comment">//GDCPIE_explode   = expl;          /* default: NULL - no explosion */</span>
00391     GDCPIE_Color     = clr;
00392     GDCPIE_BGColor   = 0xFFFFFFL;
00393 <span class="comment">/*  GDCPIE_EdgeColor = 0x000000L;          default is GDCPIE_NOCOLOR */</span> 
00394                                         <span class="comment">/* for no edging */</span>
00395     <span class="comment">//GDCPIE_missing   = missing;           /* default: NULL - none missing */</span>
00396 
00397                                         <span class="comment">/* add percentage to slice label */</span>
00398                                         <span class="comment">/* below the slice label */</span>
00399     GDCPIE_percent_labels = GDCPIE_PCT_BELOW;
00400     GDC_image_type     = GDC_PNG;
00401     <span class="comment">/* call the lib */</span>
00402     GDC_out_pie( 300,           <span class="comment">/* width */</span>
00403                  200,           <span class="comment">/* height */</span>
00404                  fp,            <span class="comment">/* open file pointer */</span>
00405                  GDC_3DPIE,     <span class="comment">/* or GDC_2DPIE */</span>
00406                  numlabels,             <span class="comment">/* number of slices */</span>
00407                  labels,            <span class="comment">/* can be NULL */</span>
00408                  fl_data );         <span class="comment">/* data array */</span>
00409 
00410     fclose( fp );
00411     
00412     
00413     <span class="comment">// fuckme  i hate char arrays</span>
00414     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numlabels; i++)
00415         <span class="keyword">delete</span> [] labels[i];
00416     
00417     <span class="keyword">delete</span> [] labels;
00418     <span class="keyword">delete</span> [] fl_data;
00419 
00420 <span class="preprocessor">#endif</span>
00421 <span class="preprocessor"></span>    
00422 }
00423 
00424  <span class="keywordtype">void</span> YardReports::OnLeave(wxCommandEvent&amp; event)
00425 {
00426     EndModal(0);
00427     
00428 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun May 9 23:08:00 2004 for YardSale by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
