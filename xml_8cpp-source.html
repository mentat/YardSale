<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>YardSale: xml.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>xml.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;iostream&gt;</span>
00002 <span class="preprocessor">#include &lt;fstream&gt;</span>
00003 <span class="preprocessor">#include &lt;map&gt;</span>
00004 <span class="preprocessor">#include &lt;list&gt;</span>
00005 <span class="preprocessor">#include &lt;string&gt;</span>
00006 <span class="preprocessor">#include &lt;stack&gt;</span>
00007 <span class="preprocessor">#include &lt;sstream&gt;</span>
00008 
00009 <span class="preprocessor">#include "xml.h"</span>
00010 
00011 <span class="preprocessor">#ifndef LOG_DEBUG</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG</span>
00013 <span class="preprocessor"></span><span class="preprocessor"> #ifdef WIN32</span>
00014 <span class="preprocessor"></span><span class="preprocessor">  #include &lt;fstream&gt;</span>
00015   <span class="keyword">static</span> ofstream debugOut(<span class="stringliteral">"xml_debug.txt"</span>);
00016 <span class="preprocessor">  #define LOG_DEBUG(str) debugOut &lt;&lt; str &lt;&lt; endl;</span>
00017 <span class="preprocessor"></span><span class="preprocessor"> #else</span>
00018 <span class="preprocessor"></span><span class="preprocessor">  #include &lt;iostream&gt;</span>
00019 <span class="preprocessor">  #define LOG_DEBUG(str) cout &lt;&lt; str &lt;&lt; endl;</span>
00020 <span class="preprocessor"></span><span class="preprocessor"> #endif</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00022 <span class="preprocessor"></span><span class="preprocessor"> #define LOG_DEBUG(str) {}</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#endif // LOG_DEBUG</span>
00025 <span class="preprocessor"></span>
00026 
00027 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00028 
00029 string XMLParser::escape(string str)
00030 {
00031     string a[] = {<span class="stringliteral">"&amp;"</span>, <span class="stringliteral">"&lt;"</span>, <span class="stringliteral">"&gt;"</span>, <span class="stringliteral">"\""</span>, <span class="stringliteral">"'"</span>};
00032     string b[] = {<span class="stringliteral">"&amp;amp;"</span>,  <span class="stringliteral">"&amp;lt;"</span>,  <span class="stringliteral">"&amp;gt;"</span>,  <span class="stringliteral">"&amp;quot;"</span>,  <span class="stringliteral">"&amp;apos;"</span>};
00033 
00034     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;5; i++) 
00035     {
00036         size_t pos=0;
00037         <span class="keywordflow">while</span> ( ( pos = str.find(a[i], pos ) ) != std::string::npos ) 
00038         {
00039            str.replace( pos, a[i].length(), b[i] );
00040            pos += b[i].length(); <span class="comment">// new starting point of search is just after 'b'</span>
00041         }
00042     }
00043     <span class="keywordflow">return</span> str;
00044 }
00045 
00046 <span class="keywordtype">void</span> XMLParser::init(<span class="keyword">const</span> string &amp;line, Type type)
00047 {
00048     <span class="keywordflow">switch</span> (type)
00049     {
00050     <span class="keywordflow">case</span> String:
00051         <span class="keywordflow">try</span> {
00052             <a class="code" href="class_expat.html#a2">parse</a>(line);
00053         }
00054         <span class="keywordflow">catch</span> (<a class="code" href="class_expat_1_1_parse_failure.html">Expat::ParseFailure</a> &amp;e)
00055         {
00056             <span class="keywordflow">throw</span> ParseFailure(e.what());
00057         }
00058         <span class="keywordflow">break</span>;
00059     <span class="keywordflow">case</span> File:
00060     {
00061         string str;
00062         ifstream in(line.c_str());
00063         <span class="keywordflow">if</span> (!in)
00064         {
00065             <span class="keywordflow">throw</span> DiskError(<span class="stringliteral">"XMLParser: Specified file cannot be opened."</span>);
00066         }
00067 
00068         <span class="keywordflow">while</span> (in.good())
00069         {
00070            getline(in,str);
00071            str+=<span class="stringliteral">"\n"</span>;
00072            <a class="code" href="class_expat.html#a2">parse</a>(str);
00073         }
00074         in.close();
00075     }
00076     <span class="keywordflow">break</span>;
00077     };
00078 
00079 }
00080 
<a name="l00081"></a><a class="code" href="class_x_m_l_parser.html#a0">00081</a> <a class="code" href="class_x_m_l_parser.html#a0">XMLParser::XMLParser</a>(<span class="keyword">const</span> string &amp;line, Type type)
00082 : <a class="code" href="class_expat.html">Expat</a>()
00083 {
00084     init(line, type);
00085 }
00086 
<a name="l00087"></a><a class="code" href="class_x_m_l_parser.html#a1">00087</a> <a class="code" href="class_x_m_l_parser.html#a0">XMLParser::XMLParser</a>(<a class="code" href="class_x_m_l_node.html">XMLNode</a> &amp;_root)
00088 : <a class="code" href="class_expat.html">Expat</a>()
00089 {
00090     root = _root;  
00091 }
00092 
00093 XMLParser::~XMLParser()
00094 {
00095     
00096 }
00097 
<a name="l00098"></a><a class="code" href="class_x_m_l_parser.html#a3">00098</a> <span class="keywordtype">int</span> <a class="code" href="class_x_m_l_parser.html#a3">XMLParser::tree_to_xml</a>(string &amp;line)
00099 {
00100     printTag(root,line);
00101     <span class="keywordflow">return</span> 0;
00102 }
00103 
<a name="l00104"></a><a class="code" href="class_x_m_l_parser.html#a4">00104</a> <span class="keywordtype">int</span> <a class="code" href="class_x_m_l_parser.html#a4">XMLParser::tree_to_file</a>(<span class="keyword">const</span> string &amp;filename)
00105 {
00106     string line;
00107     ofstream out(filename.c_str());
00108 
00109     <span class="keywordflow">if</span> (!out)
00110     {
00111         <span class="keywordflow">throw</span> <a class="code" href="class_x_m_l_parser_1_1_disk_error.html">DiskError</a>(<span class="stringliteral">"File Error!"</span>);
00112     }
00113 
00114     printTag(root,line);
00115     out &lt;&lt; line;
00116 
00117     out.close();
00118     <span class="keywordflow">return</span> 0;
00119 }
00120 
<a name="l00121"></a><a class="code" href="class_x_m_l_parser.html#a5">00121</a> vector&lt;XMLNode&gt; <a class="code" href="class_x_m_l_parser.html#a5">XMLParser::get_tags</a>(<span class="keyword">const</span> string &amp;key)
00122 {
00123     vector&lt;XMLNode&gt; ret;
00124     <span class="keywordflow">return</span> ret;
00125 }
00126 
00127 <span class="keywordtype">int</span> XMLParser::printTag(<span class="keyword">const</span> <a class="code" href="class_x_m_l_node.html">XMLNode</a> &amp;node, string &amp;ret, <span class="keywordtype">int</span> indent)
00128 {
00129     <span class="keywordtype">int</span> s(0);
00130     
00131     <span class="comment">// print indent</span>
00132     <span class="keywordflow">for</span> (s=0; s&lt;indent; s++) 
00133         ret += <span class="stringliteral">"\t"</span>;
00134 
00135     <span class="comment">// print tag name</span>
00136     ret += <span class="stringliteral">"&lt;"</span> + XMLParser::escape(node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_name);
00137     
00138     <span class="comment">// print properties</span>
00139     <span class="keywordflow">for</span> (AttributeMap::const_iterator i=node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_properties.begin();i!=node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_properties.end();i++)
00140     {
00141         <span class="keywordflow">if</span> (i-&gt;second == <span class="stringliteral">""</span>)
00142             ret+= <span class="stringliteral">" "</span> + XMLParser::escape(i-&gt;first) + <span class="stringliteral">"=\"\""</span>;
00143         <span class="keywordflow">else</span>
00144             ret+= <span class="stringliteral">" "</span> + XMLParser::escape(i-&gt;first) + <span class="stringliteral">"=\""</span> + XMLParser::escape(i-&gt;second) + <span class="stringliteral">"\""</span>;
00145     }
00146 
00147     <span class="comment">// if tag has no children, close and return</span>
00148     <span class="keywordflow">if</span> (( node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_data == <span class="stringliteral">""</span> || node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_data == <span class="stringliteral">"\n"</span>)  &amp;&amp; node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_children.empty())
00149     {
00150         LOG_DEBUG(node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_name &lt;&lt; <span class="stringliteral">" no children."</span>);
00151         ret+=<span class="stringliteral">"/&gt;"</span>;
00152         <span class="keywordflow">return</span> 0;
00153     }
00154     
00155     <span class="comment">// if has data/children</span>
00156     ret+=<span class="stringliteral">"&gt;"</span>;
00157     
00158     <span class="comment">// print children</span>
00159     <span class="keywordtype">bool</span> childprinted = <span class="keyword">false</span>;
00160     <span class="keywordflow">for</span> (NodeMap::const_iterator it=node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_children.begin();it!=node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_children.end();it++)
00161     {
00162        ret+=<span class="stringliteral">"\n"</span>;
00163        childprinted = <span class="keyword">true</span>;
00164        string tmp;
00165        LOG_DEBUG(<span class="stringliteral">"Printing children: "</span> &lt;&lt; it-&gt;second.m_xmlData-&gt;m_name); 
00166        printTag(it-&gt;second,tmp,indent+1);
00167        ret+=tmp;
00168     }
00169   
00170     <span class="comment">// indent for data</span>
00171     <span class="keywordflow">if</span> (childprinted &amp;&amp; (node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_data.length()&gt;0))
00172         <span class="keywordflow">for</span> (s=0; s&lt;indent + 1; s++) 
00173            ret += <span class="stringliteral">"\t"</span>;
00174 
00175     <span class="keywordflow">if</span> (node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;data_is_cdata)
00176         ret+=<span class="stringliteral">"&lt;![CDATA["</span>;
00177 
00178 
00179     <span class="keywordflow">if</span> (node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_data.length()&gt;0)
00180     {
00181         <span class="keywordflow">if</span> (node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;data_is_cdata)
00182            ret+=node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_data;
00183         <span class="keywordflow">else</span>
00184            ret+=XMLParser::escape(node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_data);
00185     }
00186 
00187     <span class="keywordflow">if</span> (node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;data_is_cdata)
00188         ret+=<span class="stringliteral">"]]&gt;"</span>;
00189 
00190     <span class="keywordflow">if</span> (childprinted)
00191         ret+=<span class="charliteral">'\n'</span>;
00192 
00193     <span class="comment">// print indent</span>
00194     <span class="keywordflow">if</span> (childprinted)
00195         <span class="keywordflow">for</span> (s=0; s&lt;indent; s++) ret += <span class="stringliteral">"\t"</span>;
00196     
00197     ret += <span class="stringliteral">"&lt;/"</span> + XMLParser::escape(node.<a class="code" href="class_x_m_l_node.html#p0">m_xmlData</a>-&gt;m_name) + <span class="stringliteral">"&gt;\n"</span>;
00198     
00199     <span class="keywordflow">return</span> 0;
00200 }
00201 
00202 
<a name="l00203"></a><a class="code" href="class_x_m_l_parser.html#b0">00203</a> <span class="keywordtype">void</span> <a class="code" href="class_x_m_l_parser.html#b0">XMLParser::recievedTag</a>(<a class="code" href="class_x_m_l_node.html">XMLNode</a>&amp; n)
00204 {
00205     root.<a class="code" href="class_x_m_l_node.html#a25">addChild</a>(n);
00206 }
00207 
<a name="l00208"></a><a class="code" href="class_x_m_l_parser.html#b1">00208</a> <span class="keywordtype">void</span> <a class="code" href="class_x_m_l_parser.html#b1">XMLParser::rootTagRecieved</a>(<a class="code" href="class_x_m_l_node.html">XMLNode</a>&amp; _root)
00209 {
00210     root=_root;
00211 }
00212 
00213 <span class="keywordtype">void</span> <a class="code" href="class_expat.html#b3">XMLParser::parserError</a>(<span class="keyword">const</span> string&amp; errorMsg, <span class="keywordtype">int</span> line)
00214 {
00215     stringstream error;
00216     error &lt;&lt; errorMsg &lt;&lt; <span class="stringliteral">": "</span> &lt;&lt; line;
00217     <a class="code" href="class_expat.html#a3">reset</a>();
00218 
00219     <span class="keywordflow">throw</span> ParseFailure(error.str().c_str());
00220 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun May 9 23:07:57 2004 for YardSale by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
