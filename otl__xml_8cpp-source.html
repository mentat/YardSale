<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>YardSale: otl_xml.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>otl_xml.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include "otl_xml.h"</span>
00002 <span class="preprocessor">#include &lt;string&gt;</span>
00003 <span class="preprocessor">#include &lt;sstream&gt;</span>
00004 <span class="preprocessor">#include &lt;vector&gt;</span>
00005 <span class="preprocessor">#include &lt;iostream&gt;</span>
00006 
00007 <span class="preprocessor">#define OTL_ODBC_MYSQL</span>
00008 <span class="preprocessor"></span><span class="preprocessor">#define OTL_STL</span>
00009 <span class="preprocessor"></span>
00010 <span class="preprocessor">#ifndef WIN32</span>
00011 <span class="preprocessor"></span><span class="preprocessor">#define OTL_ODBC_UNIX</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00013 <span class="preprocessor"></span><span class="preprocessor">#define OTL_ODBC</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00015 <span class="preprocessor"></span>
00016 <span class="preprocessor">#include &lt;otlv4.h&gt;</span>
00017 
00018 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00019 
00020 <span class="comment">// plan C</span>
00021 <span class="keyword">static</span> string tab(<span class="keywordtype">int</span> level)
00022 {
00023     string ret;
00024     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; level; i++)
00025         ret += <span class="stringliteral">"    "</span>;
00026     <span class="keywordflow">return</span> ret;
00027 }
00028 
00029 string ToXML(otl_stream * stream)
00030 {
00031     
00032     <span class="keywordflow">if</span> (!stream)
00033         <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00034     
00035     <span class="keywordtype">int</span> length = 0;
00036     otl_column_desc* desc = stream-&gt;describe_select(length);
00037     stringstream xml;
00038     xml &lt;&lt; <span class="stringliteral">"&lt;?xml version=\"1.0\" encoding=\"UTF-8\"&gt;"</span> &lt;&lt; endl;
00039     xml &lt;&lt; <span class="stringliteral">"&lt;result&gt;"</span> &lt;&lt; endl;
00040     
00041     <span class="keywordflow">while</span> (!stream-&gt;eof())
00042     {
00043         xml &lt;&lt; tab(1) &lt;&lt; <span class="stringliteral">"&lt;record&gt;"</span> &lt;&lt; endl;
00044 
00045         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; length; i++)
00046         {
00047             xml &lt;&lt; tab(2) &lt;&lt; <span class="stringliteral">"&lt;"</span> &lt;&lt; desc[i].name &lt;&lt; <span class="stringliteral">"&gt;"</span> &lt;&lt; endl;
00048             
00049             <span class="keywordflow">switch</span>(desc-&gt;dbtype) {
00050                 <span class="keywordflow">case</span>(otl_var_varchar_long): {
00051                     string i;
00052                     *stream &gt;&gt; i;
00053                     xml &lt;&lt; i;}
00054                     <span class="keywordflow">break</span>;
00055                 <span class="keywordflow">case</span>(otl_var_int):{
00056                     <span class="keywordtype">int</span> i;
00057                     *stream &gt;&gt; i;
00058                     xml &lt;&lt; i;}
00059                     <span class="keywordflow">break</span>;
00060                  <span class="keywordflow">case</span>(otl_var_char):{
00061                     <span class="keywordtype">char</span> i;
00062                     *stream &gt;&gt; i;
00063                     xml &lt;&lt; i;}
00064                     <span class="keywordflow">break</span>;
00065                 <span class="keywordflow">case</span>(otl_var_db2date): 
00066                 <span class="keywordflow">case</span>(otl_var_db2time): 
00067                 <span class="keywordflow">case</span>(otl_var_ltz_timestamp): 
00068                 <span class="keywordflow">case</span>(otl_var_timestamp): 
00069                 <span class="keywordflow">case</span>(otl_var_tz_timestamp): {
00070                     otl_datetime i;
00071                     *stream &gt;&gt; i;
00072                     xml &lt;&lt; i;}
00073                     <span class="keywordflow">break</span>;
00074                 <span class="keywordflow">case</span>(otl_var_float):{
00075                     <span class="keywordtype">float</span> i;
00076                     *stream &gt;&gt; i;
00077                     xml &lt;&lt; i;}
00078                     <span class="keywordflow">break</span>;
00079                 <span class="keywordflow">case</span>(otl_var_double): {
00080                     <span class="keywordtype">double</span> i;
00081                     *stream &gt;&gt; i;
00082                     xml &lt;&lt; i;}
00083                     <span class="keywordflow">break</span>;
00084                 <span class="keywordflow">case</span>(otl_var_long_int): {
00085                     <span class="keywordtype">long</span> <span class="keywordtype">int</span> i;
00086                     *stream &gt;&gt; i;
00087                     xml &lt;&lt; i;}
00088                     <span class="keywordflow">break</span>;
00089                 <span class="keywordflow">case</span>(otl_var_short):{
00090                     <span class="keywordtype">short</span> i;
00091                     *stream &gt;&gt; i;
00092                     xml &lt;&lt; i;}
00093                     <span class="keywordflow">break</span>;
00094                 <span class="keywordflow">case</span>(otl_var_unsigned_int): {
00095                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
00096                     *stream &gt;&gt; i;
00097                     xml &lt;&lt; i;}
00098                     <span class="keywordflow">break</span>;
00099 <span class="preprocessor">                #ifdef OTL_BIGINT</span>
00100 <span class="preprocessor"></span>                <span class="keywordflow">case</span>(otl_var_bigint): {
00101                     <span class="keywordtype">long</span> <span class="keywordtype">long</span> i;
00102                     *stream &gt;&gt; i;
00103                     xml &lt;&lt; i; }
00104                     <span class="keywordflow">break</span>;
00105 <span class="preprocessor">                #endif</span>
00106 <span class="preprocessor"></span><span class="preprocessor">                #if 0</span>
00107 <span class="preprocessor"></span>                <span class="keywordflow">case</span>(otl_var_clob): 
00108                 <span class="keywordflow">case</span>(otl_var_blob): {
00109                     otl_lob_stream i;
00110                     *stream &gt;&gt; i;
00111                     xml &lt;&lt; i;}
00112                     <span class="keywordflow">break</span>;
00113 <span class="preprocessor">                #endif</span>
00114 <span class="preprocessor"></span>                <span class="keywordflow">default</span>: cerr &lt;&lt; <span class="stringliteral">"Throw a fucking exception"</span> &lt;&lt; endl;
00115                     <span class="keywordflow">break</span>;
00116             }
00117             xml &lt;&lt; <span class="stringliteral">"&lt;/"</span> &lt;&lt; desc[i].name &lt;&lt; <span class="stringliteral">"&gt;"</span> &lt;&lt; endl;
00118 
00119         }
00120         xml &lt;&lt; tab(1) &lt;&lt; <span class="stringliteral">"&lt;/record&gt;"</span> &lt;&lt; endl;
00121     }
00122     xml &lt;&lt; <span class="stringliteral">"&lt;/result&gt;"</span> &lt;&lt; endl;
00123         
00124 }
00125 
00126 <span class="preprocessor">#if 0</span>
00127 <span class="preprocessor"></span><span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; 
00128 string ToString(otl_stream * stream,T&amp; v) 
00129 {
00130     stringstream st;
00131     *stream &gt;&gt; v;
00132     st &lt;&lt; v;
00133 }
00134 
00135 <span class="keyword">class </span>Shit {
00136 <span class="keyword">public</span>:
00137     
00138     Shit(<span class="keywordtype">int</span> id): m_id(id) {
00139       <span class="comment">/*  </span>
00140 <span class="comment">        switch(id) {</span>
00141 <span class="comment">            #ifdef OTL_BIGINT</span>
00142 <span class="comment">            case(otl_var_bigint): </span>
00143 <span class="comment">                m_type = new long long(0); break;</span>
00144 <span class="comment">            #endif</span>
00145 <span class="comment">            case(otl_var_blob): </span>
00146 <span class="comment">                m_type = new otl_lob_stream(); break;</span>
00147 <span class="comment">            case(otl_var_char): </span>
00148 <span class="comment">                m_type = new char(0); break;</span>
00149 <span class="comment">            case(otl_var_clob): </span>
00150 <span class="comment">                m_type = new otl_lob_stream(); break;</span>
00151 <span class="comment">            case(otl_var_db2date): </span>
00152 <span class="comment">                m_type = new otl_datetime(); break;</span>
00153 <span class="comment">            case(otl_var_db2time): </span>
00154 <span class="comment">                m_type = new otl_datetime(); break;</span>
00155 <span class="comment">            case(otl_var_double): </span>
00156 <span class="comment">                m_type = new double(0.0); break;</span>
00157 <span class="comment">            case(otl_var_float): </span>
00158 <span class="comment">                m_type = new float(0.0); break;</span>
00159 <span class="comment">            case(otl_var_int): </span>
00160 <span class="comment">                m_type = new int(0); break;</span>
00161 <span class="comment">            case(otl_var_long_int): </span>
00162 <span class="comment">                m_type = new long int(0); break;</span>
00163 <span class="comment">            case(otl_var_ltz_timestamp): </span>
00164 <span class="comment">                m_type = new otl_datetime(); break;</span>
00165 <span class="comment">            case(otl_var_raw_long): </span>
00166 <span class="comment">                m_type = new otl_lob_stream(); break;</span>
00167 <span class="comment">            case(otl_var_short): </span>
00168 <span class="comment">                m_type = new short int(0); break;</span>
00169 <span class="comment">            case(otl_var_timestamp): </span>
00170 <span class="comment">                m_type = new otl_datetime(); break;</span>
00171 <span class="comment">            case(otl_var_tz_timestamp): </span>
00172 <span class="comment">                m_type = new otl_datetime(); break;</span>
00173 <span class="comment">            case(otl_var_unsigned_int): </span>
00174 <span class="comment">                m_type = new unsigned int(0); break;</span>
00175 <span class="comment">            case(otl_var_varchar_long): </span>
00176 <span class="comment">                m_type = new string(); break;</span>
00177 <span class="comment">            default: cerr &lt;&lt; "Throw a fucking exception" &lt;&lt; endl;</span>
00178 <span class="comment">                break;</span>
00179 <span class="comment">        }*/</span>
00180     }
00181 
00182     <span class="keywordtype">int</span> GetType()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> m_id; }
00183 
00184     <span class="comment">//long long&amp; GetLLInt();// { long long(*m_type); }</span>
00185    <span class="comment">// otl_lob_stream&amp; GetLob();</span>
00186     <span class="keywordtype">char</span>&amp; GetChar();
00187     otl_datetime&amp; GetDate();
00188     <span class="keywordtype">double</span>&amp; GetDouble();
00189     <span class="keywordtype">float</span>&amp; GetFloat();
00190     <span class="keywordtype">int</span>&amp; GetInt();
00191     <span class="keywordtype">long</span> <span class="keywordtype">int</span>&amp; GetLInt();
00192     <span class="keywordtype">short</span> <span class="keywordtype">int</span>&amp; GetSInt();
00193     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; GetUInt();
00194     string&amp; GetString();
00195 
00196 <span class="keyword">private</span>:
00197     <span class="keywordtype">int</span> m_id;
00198     <span class="keywordtype">void</span> * m_type; <span class="comment">// terrible, nastly, shit</span>
00199 };
00200 
00201 <span class="keyword">class </span>OTLPoly {
00202  <span class="keyword">public</span>:
00203     OTLPoly() {}
00204         
00205     OTLPoly &amp; operator&gt;&gt;(otl_stream * stream)
00206     {
00207         <span class="keywordflow">if</span> (!stream)
00208             <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00209         
00210         <span class="keywordtype">int</span> length = 0;
00211         otl_column_desc* desc = stream-&gt;describe_select(length);
00212         
00213         PolyRow master_row;
00214         
00215         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; length; i++)
00216         {
00217             
00218             <span class="keywordflow">switch</span>(desc-&gt;dbtype) {
00219 <span class="preprocessor">                #ifdef OTL_BIGINT</span>
00220 <span class="preprocessor"></span>                <span class="keywordflow">case</span>(otl_var_bigint): 
00221                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(<span class="keywordtype">long</span> <span class="keywordtype">long</span>(0))); <span class="keywordflow">break</span>;
00222 <span class="preprocessor">                #endif</span>
00223 <span class="preprocessor"></span>                <span class="keywordflow">case</span>(otl_var_blob): 
00224                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(otl_lob_stream())); <span class="keywordflow">break</span>;
00225                 <span class="keywordflow">case</span>(otl_var_char): 
00226                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(<span class="keywordtype">char</span>(0))); <span class="keywordflow">break</span>;
00227                 <span class="keywordflow">case</span>(otl_var_clob): 
00228                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(otl_lob_stream())); <span class="keywordflow">break</span>;
00229                 <span class="keywordflow">case</span>(otl_var_db2date): 
00230                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(otl_datetime())); <span class="keywordflow">break</span>;
00231                 <span class="keywordflow">case</span>(otl_var_db2time): 
00232                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(otl_datetime())); <span class="keywordflow">break</span>;
00233                 <span class="keywordflow">case</span>(otl_var_double): 
00234                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(<span class="keywordtype">double</span>(0.0))); <span class="keywordflow">break</span>;
00235                 <span class="keywordflow">case</span>(otl_var_float): 
00236                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(<span class="keywordtype">float</span>(0.0))); <span class="keywordflow">break</span>;
00237                 <span class="keywordflow">case</span>(otl_var_int): 
00238                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(<span class="keywordtype">int</span>(0))); <span class="keywordflow">break</span>;
00239                 <span class="keywordflow">case</span>(otl_var_long_int): 
00240                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(<span class="keywordtype">long</span> <span class="keywordtype">int</span>(0))); <span class="keywordflow">break</span>;
00241                 <span class="keywordflow">case</span>(otl_var_ltz_timestamp): 
00242                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(otl_datetime())); <span class="keywordflow">break</span>;
00243                 <span class="keywordflow">case</span>(otl_var_raw_long): 
00244                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(otl_lob_stream())); <span class="keywordflow">break</span>;
00245                 <span class="keywordflow">case</span>(otl_var_short): 
00246                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(<span class="keywordtype">short</span> <span class="keywordtype">int</span>(0))); <span class="keywordflow">break</span>;
00247                 <span class="keywordflow">case</span>(otl_var_timestamp): 
00248                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(otl_datetime())); <span class="keywordflow">break</span>;
00249                 <span class="keywordflow">case</span>(otl_var_tz_timestamp): 
00250                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(otl_datetime())); <span class="keywordflow">break</span>;
00251                 <span class="keywordflow">case</span>(otl_var_unsigned_int): 
00252                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>(0))); <span class="keywordflow">break</span>;
00253                 <span class="keywordflow">case</span>(otl_var_varchar_long): 
00254                     master_row.Data().push_back(<span class="keyword">new</span> variant_t(string())); <span class="keywordflow">break</span>;
00255                 <span class="keywordflow">default</span>: cerr &lt;&lt; <span class="stringliteral">"Throw a fucking exception"</span> &lt;&lt; endl;
00256                     <span class="keywordflow">break</span>;
00257             }
00258 
00259         }
00260 
00261         <span class="keywordflow">while</span>(!stream-&gt;eof()) {
00262             
00263             PolyRow temp(master_row); <span class="comment">// hoping this will copy the templates over</span>
00264             
00265             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; temp.Data().size(); i++)
00266             {
00267                 *stream &gt;&gt; temp.Data()[i];
00268             }
00269         }
00270         
00271         <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00272     }
00273     
00274  <span class="keyword">private</span>:
00275     
00276     vector&lt;string&gt; m_rowNames;
00277     vector&lt;PolyRow&gt; m_rows;
00278     
00279 };
00280 
00281 
00282 <span class="preprocessor">#endif</span>
00283 <span class="preprocessor"></span><span class="preprocessor">#if 0</span>
00284 <span class="preprocessor"></span><span class="keyword">static</span> string otl_xml::process(otl_stream * stream)
00285 {
00286     stringstream xml;
00287     xml &lt;&lt; <span class="stringliteral">"&lt;?xml version=\"1.0\" encoding=\"UTF-8\"&gt;"</span> &lt;&lt; endl;
00289 
00290     <span class="keywordtype">int</span> length; <span class="comment">// maybe instead use describe_select, see OTL example 33</span>
00291     otl_column_desc* desc = stream-&gt;describe_select(length);
00292     
00293     <span class="keywordflow">if</span> (length == 0)
00294     {
00295         cerr &lt;&lt; <span class="stringliteral">"Length is 0, aborting.\n"</span>;
00296         <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00297     }
00298 
00299     an_otl_type * array = <span class="keyword">new</span> an_otl_array[length];
00300 
00301     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; length; i++) {
00302         array[i].kind = GetKind(desc[i].ftype);
00303         array[i].data = GetType(desc[i].ftype);
00304     }
00305 
00306     <span class="keywordflow">while</span> (!stream-&gt;eof()) {
00307         
00309         an_otl_type temp;
00310 
00311         <span class="keywordflow">try</span> {
00312             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; length; i++)
00313                 *stream &gt;&gt; temp.RefData(); 
00314 
00315         } <span class="keywordflow">catch</span> (otl_exception &amp;e) {
00316             cerr &lt;&lt; <span class="stringliteral">"There was an exception..."</span> &lt;&lt; endl;
00317         }
00318 
00319         xml &lt;&lt; tab(1) &lt;&lt; <span class="stringliteral">"&lt;row&gt;"</span> &lt;&lt; endl;
00321         xml &lt;&lt; tab(2) &lt;&lt; <span class="stringliteral">"&lt;"</span> &lt;&lt; array[i].name &lt;&lt; <span class="stringliteral">"&gt;"</span> 
00322             &lt;&lt; temp.GetData() &lt;&lt; <span class="stringliteral">"&lt;/"</span> &lt;&lt; array[i].name &lt;&lt; <span class="stringliteral">"&gt;"</span> &lt;&lt; endl;
00323 
00324     }   
00325 }
00326 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun May 9 23:07:57 2004 for YardSale by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
